<beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
  http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd">

  <bean id="eventProcessor" class="org.fcrepo.camel.processor.EventProcessor"/>

  <camelContext xmlns="http://camel.apache.org/schema/spring" id="UmdFcrepoEventRouter" streamCache="true">

    <route id="edu.umd.lib.camel.routes.FedoraEvents">
      <from uri="activemq:queue:fedora"/>
      <!-- log loggingLevel="DEBUG" message="batch user: ${BATCH_USER}"/ -->
      <process ref="eventProcessor"/>
      <setHeader headerName="CamelFcrepoUser">
        <header>org.fcrepo.jms.user</header>
      </setHeader>
      <setHeader headerName="CamelFcrepoUserAgent">
        <header>org.fcrepo.jms.userAgent</header>
      </setHeader>
      <setHeader headerName="CamelFcrepoEventType">
        <header>org.fcrepo.jms.eventType</header>
      </setHeader>
      <setHeader headerName="CamelFcrepoResourceType">
        <header>org.fcrepo.jms.resourceType</header>
      </setHeader>
      <setHeader headerName="CamelFcrepoPath">
        <header>org.fcrepo.jms.identifier</header>
      </setHeader>
      <log loggingLevel="DEBUG" message="Event user: ${header.CamelFcrepoUser}"/>
      <log loggingLevel="DEBUG" message="Event user agent: ${header.CamelFcrepoUserAgent}"/>
      <log loggingLevel="INFO" message="Routing event for resource with URI: ${header.CamelFcrepoUri}"/>
      <removeHeaders pattern="org.fcrepo.*"/>
      <filter>
        <simple>${header.CamelFcrepoPath} in "/pcdm,/annotations"</simple>
        <log loggingLevel="DEBUG" message="Skip path detected. Suppressing ${header.CamelFcrepoEventType} for '${header.CamelFcrepoPath}'."/>
        <stop/>
      </filter>
      <filter>
        <simple>${header.CamelFcrepoUser} == "CN=batchloader"</simple>
        <to uri="direct:batch"/>
        <stop/>
      </filter>
      <to uri="direct:distribution"/>
    </route>

    <route id="edu.umd.lib.camel.routes.BatchEvents">
      <from uri="direct:batch"/>
      <log loggingLevel="DEBUG" message="Processing batch event"/>
      <filter>
        <simple>${header.CamelFcrepoPath} contains '#'</simple>
        <log loggingLevel="DEBUG" message="URI with fragment detected. Suppressing '${header.CamelFcrepoUri}' node event for batch user."/>
        <stop/>
      </filter>
      <setHeader headerName="JMSPriority">
        <constant>3</constant>
      </setHeader>
      <setHeader headerName="UMDBatchEvent">
        <constant>true</constant>
      </setHeader>
      <to uri="direct:distribution"/>
    </route>

    <route id="edu.umd.lib.camel.routes.Distribution">
      <from uri="direct:distribution"/>
      <log loggingLevel="DEBUG" message="Distributing event for ${header.CamelFcrepoUri}"/>
      <multicast parallelProcessing="true">
        <filter>
          <simple>${header.CamelFcrepoResourceType} contains "http://fedora.info/definitions/v4/repository#Binary"</simple>
          <to uri="direct:binary"/>
        </filter>
        <to uri="activemq:queue:fedorasolr"/>
        <to uri="activemq:queue:fedoratriplestore"/>
        <to uri="activemq:queue:fedoraaudit"/>
      </multicast>
    </route>

    <route id="edu.umd.lib.camel.routes.Binaries">
      <from uri="direct:binary"/>
      <filter>
        <!--
          if the message is about a new binary, remove all headers except for CamelFcrepoUri,
          clear the body, and send to the fixity candidates queue
        -->
        <simple>${header.CamelFcrepoEventType} contains "http://fedora.info/definitions/v4/event#ResourceCreation"</simple>
        <log loggingLevel="INFO" message="New binary detected, sending to fixity candidates queue"/>
          <!-- clean out unnecessary headers (just leave the fcrepo URI), and clear the body -->
        <removeHeaders pattern="*" excludePattern="CamelFcrepoUri"/>
        <setBody>
          <constant></constant>
        </setBody>
        <to uri="activemq:queue:fixitycandidates"/>
      </filter>
      <!-- send to fixity processing -->
      <to uri="activemq:queue:fedorafixity"/>
    </route>

  </camelContext>
</beans>
